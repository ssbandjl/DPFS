git repo: https://github.com/ssbandjl/DPFS
update submodule: git submodule update --init --recursive


DPFS Arch:

dpfs_kv/main.cpp -> main
    dpfs_fuse_main
        dpfs_fuse_new
            fuse_ll_map(f_ll)
            hal_params.ops.request_handler = fuse_handle_req;
                fuse_handler_t h = fuse_ll->fuse_handlers[in_hdr->opcode]
            hal_params.ops.register_device = register_dpfs_device;
                ndevices++
            hal_params.ops.unregister_device = unregister_dpfs_device;
            struct dpfs_hal *hal = dpfs_hal_new(&hal_params, false)
        dpfs_fuse_loop


HAL -> dpfs_hal/src/snap.c
dpfs_hal_new
    struct dpfs_hal *hal = calloc(1, sizeof(struct dpfs_hal))
    nvme_init_logger
    mlnx_snap_pci_manager_init
    dpfs_hal_init_dev
        struct virtio_fs_ctrl_init_attr param
        struct virtio_fs_ctrl *snap_ctrl = virtio_fs_ctrl_init(&param)
        hal->ops.register_device(hal->user_data, device_id)
    pthread_create(&hal->mock_thread, NULL, dpfs_hal_mock_thread, hal)
        virtio_fs_ctrl_progress_all_io
        virtio_fs_ctrl_progress
        virtio_fs_ctrl_suspend

dpfs_hal_handle_req


introduce:
DPFS æ¡†æž¶å…è®¸äº‘å’Œæ•°æ®ä¸­å¿ƒè¿è¥å•†ä½¿ç”¨ DPU å¸è½½ä¸ºç§Ÿæˆ·æä¾›è™šæ‹ŸåŒ–æ–‡ä»¶ç³»ç»ŸæœåŠ¡ã€‚å€ŸåŠ© DPFSï¼Œå®Œæ•´çš„æ–‡ä»¶ç³»ç»Ÿå®žçŽ°å¯åœ¨ DPU çš„ CPU å¤åˆä½“ä¸Šè¿è¡Œã€‚ç§Ÿæˆ·é€šè¿‡virtio-fsDPU åœ¨ PCIe ä¸Šå…¬å¼€çš„è®¾å¤‡ï¼ˆé€šè¿‡ SR-IOV å®žçŽ°å¤šç§Ÿæˆ·ï¼‰ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿã€‚DPFS æä¾›ç¡¬ä»¶æŠ½è±¡å±‚ã€FUSE API å®žçŽ°å’Œå¤šä¸ªæ–‡ä»¶ç³»ç»Ÿå®žçŽ°ã€‚, è­¦å‘Šï¼šDPFS ç›®å‰æ˜¯ä¸€ä¸ªç ”ç©¶é¡¹ç›®ï¼Œå› æ­¤å…¶ä»£ç å°šæœªç»è¿‡å®žæˆ˜æµ‹è¯•ï¼Œä¹Ÿä¸æ˜¯å¾ˆå¹²å‡€ã€‚è¯·è‡ªè¡Œå†³å®šæ˜¯å¦ä½¿ç”¨

åœ¨ BlueField-2ï¼ˆç›®å‰ä»…æ”¯æŒ DPUï¼‰ä¸Šè¿è¡Œæ‰€éœ€çš„ Nvidia SNAP åº“æ˜¯é—­æºçš„ï¼Œéœ€è¦è¡¥ä¸æ‰èƒ½å¯ç”¨å¼‚æ­¥è¯·æ±‚å®Œæˆ

è”ç³»æ–¹å¼å’Œè‡´è°¢
ðŸ‡¨ðŸ‡­ IBM è‹é»Žä¸–ç ”ç©¶ä¸­å¿ƒæ··åˆäº‘/åŸºç¡€è®¾æ–½è½¯ä»¶å°ç»„
ðŸ‡³ðŸ‡± é˜¿å§†æ–¯ç‰¹ä¸¹è‡ªç”±å¤§å­¦çš„ StoNet ç ”ç©¶





fuse_ll_map
    fuse_ll->fuse_handlers[FUSE_INIT] = fuse_ll_init;
    fuse_ll->fuse_handlers[FUSE_DESTROY] = fuse_ll_destroy;
    fuse_ll->fuse_handlers[FUSE_GETATTR] = fuse_ll_getattr;
    fuse_ll->fuse_handlers[FUSE_LOOKUP] = fuse_ll_lookup;
    fuse_ll->fuse_handlers[FUSE_SETATTR] = fuse_ll_setattr;
    fuse_ll->fuse_handlers[FUSE_OPENDIR] = fuse_ll_opendir;
    fuse_ll->fuse_handlers[FUSE_RELEASEDIR] = fuse_ll_releasedir;
    fuse_ll->fuse_handlers[FUSE_READDIR] = fuse_ll_readdir;
    fuse_ll->fuse_handlers[FUSE_READDIRPLUS] = fuse_ll_readdirplus;
    fuse_ll->fuse_handlers[FUSE_OPEN] = fuse_ll_open;
    fuse_ll->fuse_handlers[FUSE_RELEASE] = fuse_ll_release;
    //// We don't impl FUSE_FLUSH. The only use would be to return w
    //// but that's of no use with a remote file system
    fuse_ll->fuse_handlers[FUSE_FSYNC] = fuse_ll_fsync;
    fuse_ll->fuse_handlers[FUSE_FSYNCDIR] = fuse_ll_fsyncdir;
    fuse_ll->fuse_handlers[FUSE_CREATE] = fuse_ll_create;
    fuse_ll->fuse_handlers[FUSE_RMDIR] = fuse_ll_rmdir;
    fuse_ll->fuse_handlers[FUSE_FORGET] = fuse_ll_forget;
    fuse_ll->fuse_handlers[FUSE_BATCH_FORGET] = fuse_ll_batch_forget
    fuse_ll->fuse_handlers[FUSE_RENAME] = fuse_ll_rename;
    fuse_ll->fuse_handlers[FUSE_RENAME2] = fuse_ll_rename2;
    fuse_ll->fuse_handlers[FUSE_READ] = fuse_ll_read;
    fuse_ll->fuse_handlers[FUSE_WRITE] = fuse_ll_write;
    fuse_ll->fuse_handlers[FUSE_MKNOD] = fuse_ll_mknod;
    fuse_ll->fuse_handlers[FUSE_MKDIR] = fuse_ll_mkdir;
    fuse_ll->fuse_handlers[FUSE_SYMLINK] = fuse_ll_symlink;
    fuse_ll->fuse_handlers[FUSE_STATFS] = fuse_ll_statfs;
    fuse_ll->fuse_handlers[FUSE_UNLINK] = fuse_ll_unlink;
    fuse_ll->fuse_handlers[FUSE_READLINK] = fuse_ll_readlink;
    fuse_ll->fuse_handlers[FUSE_FLUSH] = fuse_ll_flush;
    fuse_ll->fuse_handlers[FUSE_SETLKW] = fuse_ll_setlkw;
    fuse_ll->fuse_handlers[FUSE_SETLK] = fuse_ll_setlk;
    fuse_ll->fuse_handlers[FUSE_FALLOCATE] = fuse_ll_fallocate;



dpfs_template/main.c -> main
    hal_params.ops.request_handler = fuse_handler
    struct dpfs_hal *hal = dpfs_hal_new(&hal_params, false)
    dpfs_hal_loop(hal)
        start_low_latency
            open("/dev/cpu_dma_latency", O_WRONLY)
        dpfs_hal_loop_static
            pthread_create(&hal->mock_thread, NULL, dpfs_hal_mock_thread, hal)
            pthread_create(&tdatas[i].thread, NULL, dpfs_hal_loop_static_thread, &tdatas[i])
                sched_setaffinity(gettid(), sizeof(loop_cpu), &loop_cpu)
                all_devices_suspended
                    virtio_fs_ctrl_is_suspended(hal->devices[i].snap_ctrl)
                dpfs_hal_poll_device(&hal->devices[i])
                    virtio_fs_ctrl_progress_all_io(dev->snap_ctrl)
                    virtio_fs_ctrl_progress(dev->snap_ctrl)
        stop_low_latency
            close(pm_qos_fd)
